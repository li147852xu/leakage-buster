
<!doctype html><html lang="zh"><meta charset="utf-8"/>
<title>Leakage Buster æŠ¥å‘Š</title>
<style>
  body{font-family:system-ui,Segoe UI,Arial,PingFang SC; margin:24px}
  .risk{border:1px solid #ddd; border-radius:8px; padding:12px 16px; margin:12px 0}
  .sev-high{border-left:6px solid #d9534f}.sev-medium{border-left:6px solid #f0ad4e}.sev-low{border-left:6px solid #5bc0de}
  code,pre{background:#f8f8f8; padding:2px 4px; border-radius:4px}
  .summary{background:#f9f9f9; border:1px solid #ddd; border-radius:8px; padding:16px; margin:16px 0}
  .fix-card{background:#e8f5e8; border:1px solid #c3e6c3; border-radius:8px; padding:12px; margin:8px 0}
  .fix-high{background:#fdf2f2; border-color:#f5c6cb}
  .fix-medium{background:#fff3cd; border-color:#ffeaa7}
  .fix-low{background:#d1ecf1; border-color:#bee5eb}
  .stat-leak-section{background:#f0f8ff; border:2px solid #4a90e2; border-radius:8px; padding:16px; margin:16px 0}
  .leak-score{font-weight:bold; color:#d9534f}
  .evidence-toggle{cursor:pointer; color:#4a90e2; text-decoration:underline}
  .evidence-details{display:none; margin-top:8px; padding:8px; background:#f8f9fa; border-radius:4px}
  .simulation-results{background:#fff3cd; border:1px solid #ffeaa7; border-radius:8px; padding:12px; margin:12px 0}
  .comparison-table{border-collapse:collapse; width:100%; margin:8px 0}
  .comparison-table th, .comparison-table td{border:1px solid #ddd; padding:8px; text-align:left}
  .comparison-table th{background:#f5f5f5}
  .leak-high{background:#fdf2f2}
  .leak-medium{background:#fff3cd}
  .leak-low{background:#d1ecf1}
  ul{margin:8px 0; padding-left:20px}
</style>
<h1>Leakage Buster æŠ¥å‘Š v0.3</h1>
<div>å‘½ä»¤å‚æ•°ï¼š<code>{{ meta["args"] }}</code></div>
<div>ç›®æ ‡åˆ—ï¼š<code>{{ meta["target"] }}</code>ï¼›æ—¶é—´åˆ—ï¼š<code>{{ meta["time_col"] or "æœªæŒ‡å®š" }}</code>ï¼›CVç­–ç•¥ï¼š<code>{{ meta["cv_type"] or "æœªæŒ‡å®š" }}</code></div>
<div>æ ·æœ¬æ•°ï¼š{{ meta["n_rows"] }}ï¼›ç‰¹å¾æ•°ï¼š{{ meta["n_cols"] }}</div>
{% if meta.get("simulate_cv") %}
<div>æ—¶åºæ¨¡æ‹Ÿï¼š<code>{{ meta["simulate_cv"] }}</code>ï¼›æ³„æ¼é˜ˆå€¼ï¼š<code>{{ meta["leak_threshold"] }}</code></div>
{% endif %}

<!-- ä¿®å¤å»ºè®®æ‘˜è¦å¡ç‰‡åŒºåŸŸ -->
{% if results["risks"] %}
<div class="summary">
  <h2>ğŸ”§ ä¿®å¤å»ºè®®æ‘˜è¦</h2>
  {% set high_risks = results["risks"] | selectattr("severity", "equalto", "high") | list %}
  {% set medium_risks = results["risks"] | selectattr("severity", "equalto", "medium") | list %}
  {% set low_risks = results["risks"] | selectattr("severity", "equalto", "low") | list %}
  
  {% if high_risks %}
  <div class="fix-card fix-high">
    <h4>ğŸš¨ é«˜å±é—®é¢˜ï¼ˆ{{ high_risks|length }}ä¸ªï¼‰</h4>
    <ul>
    {% for r in high_risks %}
      <li><strong>{{ r["name"] }}</strong>
        {% if r["name"].startswith("Target leakage") %}
          - ç«‹å³åˆ é™¤æˆ–åœ¨CVå†…é‡ç®—ç›¸å…³åˆ—
        {% elif r["name"].startswith("Target Encoding") %}
          - æ£€æŸ¥æ˜¯å¦ä½¿ç”¨äº†å…¨é‡ç›®æ ‡ç¼–ç ï¼Œæ”¹ä¸ºCVå†…ç¼–ç 
        {% elif r["name"].startswith("WOE") %}
          - æ£€æŸ¥WOEè®¡ç®—æ˜¯å¦ä½¿ç”¨äº†æœªæ¥ä¿¡æ¯
        {% elif r["name"].startswith("Rolling statistics") %}
          - ç¡®ä¿æ»šåŠ¨ç»Ÿè®¡ä»…ä½¿ç”¨å†å²çª—å£æ•°æ®
        {% elif r["name"].startswith("Aggregation traces") %}
          - æ£€æŸ¥èšåˆç»Ÿè®¡æ˜¯å¦åœ¨CVå†…æ­£ç¡®è®¡ç®—
        {% endif %}
        {% if r.get("leak_score", 0) > 0 %}
        <span class="leak-score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  {% if medium_risks %}
  <div class="fix-card fix-medium">
    <h4>âš ï¸ ä¸­å±é—®é¢˜ï¼ˆ{{ medium_risks|length }}ä¸ªï¼‰</h4>
    <ul>
    {% for r in medium_risks %}
      <li><strong>{{ r["name"] }}</strong>
        {% if r["name"].startswith("KFold leakage") %}
          - è€ƒè™‘ä½¿ç”¨GroupKFoldé¿å…ç»„é—´æ³„æ¼
        {% elif r["name"].startswith("Target leakage (categorical") %}
          - æ£€æŸ¥ç±»åˆ«ç‰¹å¾æ˜¯å¦ç”±ç›®æ ‡èšåˆäº§ç”Ÿ
        {% endif %}
        {% if r.get("leak_score", 0) > 0 %}
        <span class="leak-score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  {% if low_risks %}
  <div class="fix-card fix-low">
    <h4>ğŸ’¡ å»ºè®®ä¼˜åŒ–ï¼ˆ{{ low_risks|length }}ä¸ªï¼‰</h4>
    <ul>
    {% for r in low_risks %}
      <li><strong>{{ r["name"] }}</strong>
        {% if r["name"].startswith("Time-awareness") %}
          - ä½¿ç”¨æ—¶é—´æ„ŸçŸ¥çš„ç‰¹å¾å·¥ç¨‹å’ŒéªŒè¯ç­–ç•¥
        {% elif r["name"].startswith("CV strategy recommendation") %}
          - è€ƒè™‘é‡‡ç”¨æ¨èçš„CVç­–ç•¥
        {% endif %}
        {% if r.get("leak_score", 0) > 0 %}
        <span class="leak-score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
        {% endif %}
      </li>
    {% endfor %}
    </ul>
  </div>
  {% endif %}
  
  <p><strong>è¯¦ç»†ä¿®å¤ä»£ç è§ï¼š</strong> <code>fix_transforms.py</code></p>
</div>
{% endif %}

<hr/>

<!-- Statistical Leakage æ¿å— -->
<div class="stat-leak-section">
  <h2>ğŸ“Š Statistical Leakage Detection</h2>
  <p><em>v0.3æ–°å¢ï¼šæ£€æµ‹ç›®æ ‡ç¼–ç (TE)ã€WOEã€æ»šåŠ¨ç»Ÿè®¡ç­‰ç»Ÿè®¡ç±»æ³„æ¼</em></p>
  
  {% set stat_risks = [] %}{% for r in results["risks"] %}{% if "Target Encoding" in r["name"] or "WOE" in r["name"] or "Rolling statistics" in r["name"] or "Aggregation traces" in r["name"] %}{% set _ = stat_risks.append(r) %}{% endif %}{% endfor %}
  {% if stat_risks %}
    <h3>æ£€æµ‹åˆ°çš„ç»Ÿè®¡ç±»æ³„æ¼é£é™©</h3>
    {% for r in stat_risks %}
      <div class="risk sev-{{ 'high' if r['severity']=='high' else 'medium' if r['severity']=='medium' else 'low' }}">
        <h4>{{ r["name"] }} 
          {% if r.get("leak_score", 0) > 0 %}
          <span class="leak-score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
          {% endif %}
        </h4>
        <p>{{ r["detail"] }}</p>
        
        {% if r["evidence"].get("suspicious_columns") %}
        <div>
          <span class="evidence-toggle" onclick="toggleEvidence('{{ r['name']|replace(' ', '_') }}')">ç‚¹å‡»æŸ¥çœ‹è¯¦ç»†è¯æ®</span>
          <div id="{{ r['name']|replace(' ', '_') }}" class="evidence-details">
            <h5>å¯ç–‘ç‰¹å¾è¯¦æƒ…ï¼š</h5>
            <table class="comparison-table">
              <tr>
                <th>ç‰¹å¾å</th>
                <th>ç›¸å…³æ€§</th>
                <th>é£é™©åˆ†</th>
                <th>å»ºè®®</th>
              </tr>
              {% for col, details in r["evidence"]["suspicious_columns"].items() %}
              <tr class="leak-{{ 'high' if details.get('leak_score', 0) >= 0.7 else 'medium' if details.get('leak_score', 0) >= 0.5 else 'low' }}">
                <td><code>{{ col }}</code></td>
                <td>{{ "%.3f"|format(details.get('correlation', 0)) }}</td>
                <td>{{ "%.2f"|format(details.get('leak_score', 0)) }}</td>
                <td>
                  {% if 'te' in col.lower() or 'target_enc' in col.lower() %}
                    åˆ é™¤æˆ–æ”¹ä¸ºCVå†…ç¼–ç 
                  {% elif 'woe' in col.lower() %}
                    æ£€æŸ¥WOEè®¡ç®—æ—¶é—´çª—å£
                  {% elif 'rolling' in col.lower() or 'moving' in col.lower() %}
                    ç¡®ä¿ä»…ä½¿ç”¨å†å²çª—å£
                  {% else %}
                    æ£€æŸ¥èšåˆç»Ÿè®¡è®¡ç®—æ–¹å¼
                  {% endif %}
                </td>
              </tr>
              {% endfor %}
            </table>
          </div>
        </div>
        {% else %}
        <pre>{{ r["evidence"] | tojson(indent=2) }}</pre>
        {% endif %}
      </div>
    {% endfor %}
  {% else %}
    <p>âœ… æœªæ£€æµ‹åˆ°æ˜æ˜¾çš„ç»Ÿè®¡ç±»æ³„æ¼é£é™©ã€‚</p>
  {% endif %}
</div>

<hr/>

<!-- æ—¶åºæ¨¡æ‹Ÿç»“æœ -->
{% if simulation %}
<div class="simulation-results">
  <h2>â° Time Series Simulation Results</h2>
  <p><em>å¯¹æ¯”TimeSeriesSplitä¸KFoldçš„OOFæŒ‡æ ‡å˜åŒ–</em></p>
  
  {% if simulation.get("error") %}
    <p style="color: #d9534f;">âŒ æ¨¡æ‹Ÿå¤±è´¥ï¼š{{ simulation["error"] }}</p>
  {% else %}
    <div>
      <h3>æ¨¡æ‹Ÿæ‘˜è¦</h3>
      <ul>
        <li>æ€»ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["total_features"] }}</li>
        <li>æ³„æ¼ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["leak_features"] }}</li>
        <li>é«˜å±æ³„æ¼ç‰¹å¾æ•°ï¼š{{ simulation["summary"]["high_leak_features"] }}</li>
        <li>æ³„æ¼ç‡ï¼š{{ "%.1f"|format(simulation["summary"]["leak_rate"] * 100) }}%</li>
        <li>å¹³å‡åˆ†æ•°å·®å¼‚ï¼š{{ "%.4f"|format(simulation["summary"]["avg_score_diff"]) }}</li>
        <li>æœ€å¤§åˆ†æ•°å·®å¼‚ï¼š{{ "%.4f"|format(simulation["summary"]["max_score_diff"]) }}</li>
      </ul>
    </div>
    
    {% if simulation["simulation_results"]["comparisons"] %}
    <div>
      <h3>è¯¦ç»†å¯¹æ¯”ç»“æœ</h3>
      <table class="comparison-table">
        <tr>
          <th>ç‰¹å¾å</th>
          <th>TimeSeries CV</th>
          <th>KFold CV</th>
          <th>åˆ†æ•°å·®å¼‚</th>
          <th>æ³„æ¼çŠ¶æ€</th>
          <th>ä¸¥é‡ç¨‹åº¦</th>
        </tr>
        {% for comp in simulation["simulation_results"]["comparisons"] %}
        <tr class="leak-{{ comp.get('leak_severity', 'none') }}">
          <td><code>{{ comp["feature"] }}</code></td>
          <td>{{ "%.4f"|format(comp["timeseries_cv"]["mean"]) }} Â± {{ "%.4f"|format(comp["timeseries_cv"]["std"]) }}</td>
          <td>{{ "%.4f"|format(comp["kfold_cv"]["mean"]) }} Â± {{ "%.4f"|format(comp["kfold_cv"]["std"]) }}</td>
          <td>{{ "%.4f"|format(comp["score_difference"]) }}</td>
          <td>{% if comp["is_leak"] %}ğŸš¨ æ˜¯{% else %}âœ… å¦{% endif %}</td>
          <td>{{ comp.get("leak_severity", "none").upper() }}</td>
        </tr>
        {% endfor %}
      </table>
    </div>
    {% endif %}
  {% endif %}
</div>
{% endif %}

<hr/>

<!-- è¯¦ç»†é£é™©é¡¹ -->
<h2>ğŸ“‹ è¯¦ç»†æ£€æµ‹ç»“æœ</h2>
{% if results["risks"] %}
  {% for r in results["risks"] %}
    <div class="risk sev-{{ 'high' if r['severity']=='high' else 'medium' if r['severity']=='medium' else 'low' }}">
      <h3>{{ r["name"] }}ï¼ˆ{{ r["severity"] }}ï¼‰
        {% if r.get("leak_score", 0) > 0 %}
        <span class="leak-score">[é£é™©åˆ†: {{ "%.2f"|format(r["leak_score"]) }}]</span>
        {% endif %}
      </h3>
      <p>{{ r["detail"] }}</p>
      <pre>{{ r["evidence"] | tojson(indent=2) }}</pre>
    </div>
  {% endfor %}
{% else %}
  <p>âœ… æœªå‘ç°æ˜æ˜¾é£é™©é¡¹ã€‚</p>
{% endif %}

<hr/>
<p><em>æŠ¥å‘Šç”Ÿæˆæ—¶é—´ï¼š{{ now }}</em></p>

<script>
function toggleEvidence(id) {
  var element = document.getElementById(id);
  if (element.style.display === "none") {
    element.style.display = "block";
  } else {
    element.style.display = "none";
  }
}
</script>
</html>

