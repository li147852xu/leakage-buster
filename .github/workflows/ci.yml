
name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: [3.9, 3.10, 3.11, 3.12]

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4
      with:
        python-version: ${{ matrix.python-version }}
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install pytest pytest-cov
    
    - name: Run tests
      run: |
        pytest tests/ -v --cov=src/leakage_buster --cov-report=xml
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: ./coverage.xml
        flags: unittests
        name: codecov-umbrella

  leakage-check:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Run leakage detection on examples
      run: |
        # åŸºæœ¬æ£€æµ‹
        leakage-buster run --train examples/synth_train.csv --target y --time-col date --out runs/ci_basic
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "Basic check exit code: $?"
        
        # å¸¦æ—¶åºæ¨¡æ‹Ÿçš„æ£€æµ‹
        leakage-buster run --train examples/homecredit_te.csv --target y --time-col date --out runs/ci_te --simulate-cv time --leak-threshold 0.02
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "TE check exit code: $?"
        
        # å¸¦ç­–ç•¥å®¡è®¡çš„æ£€æµ‹
        leakage-buster run --train examples/group_cv.csv --target y --time-col date --out runs/ci_audit --cv-policy-file conf/cv_policy.yaml
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "Policy audit exit code: $?"
    
    - name: Test auto-fix plan
      run: |
        leakage-buster run --train examples/homecredit_te.csv --target y --time-col date --out runs/ci_plan --auto-fix plan --fix-json runs/ci_plan/fix_plan.json
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "Auto-fix plan exit code: $?"
        
        # éªŒè¯ä¿®å¤è®¡åˆ’æ–‡ä»¶
        if [ -f "runs/ci_plan/fix_plan.json" ]; then
          echo "Fix plan generated successfully"
          cat runs/ci_plan/fix_plan.json | jq '.summary'
        else
          echo "Fix plan generation failed"
          exit 1
        fi
    
    - name: Test auto-fix apply
      run: |
        leakage-buster run --train examples/homecredit_te.csv --target y --time-col date --out runs/ci_apply --auto-fix apply --fixed-train runs/ci_apply/fixed_train.csv
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "Auto-fix apply exit code: $?"
        
        # éªŒè¯ä¿®å¤åçš„æ–‡ä»¶
        if [ -f "runs/ci_apply/fixed_train.csv" ]; then
          echo "Fixed training data generated successfully"
          wc -l runs/ci_apply/fixed_train.csv
        else
          echo "Fixed training data generation failed"
          exit 1
        fi
    
    - name: Test SARIF export
      run: |
        leakage-buster run --train examples/fraud_rolling.csv --target y --time-col ts --out runs/ci_sarif --export-sarif runs/ci_sarif/leakage.sarif
        
        # æ£€æŸ¥é€€å‡ºç 
        echo "SARIF export exit code: $?"
        
        # éªŒè¯SARIFæ–‡ä»¶
        if [ -f "runs/ci_sarif/leakage.sarif" ]; then
          echo "SARIF file generated successfully"
          cat runs/ci_sarif/leakage.sarif | jq '.runs[0].results | length'
        else
          echo "SARIF file generation failed"
          exit 1
        fi

  high-leakage-gate:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Create high-leakage test data
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        
        # åˆ›å»ºé«˜æ³„æ¼æ•°æ®
        df = pd.DataFrame({
            'date': pd.date_range('2023-01-01', periods=100, freq='D'),
            'leaky_col': np.random.normal(0, 1, 100),  # é«˜ç›¸å…³åˆ—
            'normal_col': np.random.normal(0, 1, 100),
            'y': np.random.binomial(1, 0.3, 100)
        })
        
        # è®©leaky_colä¸yé«˜åº¦ç›¸å…³
        df['leaky_col'] = df['y'] * 10 + np.random.normal(0, 0.1, 100)
        
        df.to_csv('high_leakage_test.csv', index=False)
        print('High leakage test data created')
        "
    
    - name: Run leakage detection with high-leakage data
      run: |
        leakage-buster run --train high_leakage_test.csv --target y --time-col date --out runs/ci_high_leakage
        
        # æ£€æŸ¥é€€å‡ºç ï¼Œåº”è¯¥æ˜¯3ï¼ˆhigh-leakage-foundï¼‰
        exit_code=$?
        echo "High leakage check exit code: $exit_code"
        
        if [ $exit_code -eq 3 ]; then
          echo "âœ… High leakage correctly detected (exit code 3)"
        else
          echo "âŒ High leakage not detected (exit code $exit_code)"
          exit 1
        fi
    
    - name: Test CI gating
      run: |
        # æ¨¡æ‹ŸCIé˜»æ–­é€»è¾‘
        leakage-buster run --train high_leakage_test.csv --target y --time-col date --out runs/ci_gate
        
        exit_code=$?
        echo "CI gate exit code: $exit_code"
        
        case $exit_code in
          0)
            echo "âœ… No leakage detected - CI passes"
            ;;
          2)
            echo "âš ï¸ Warnings detected - CI passes with warnings"
            ;;
          3)
            echo "ğŸš¨ High leakage detected - CI blocked"
            exit 1  # é˜»æ–­CI
            ;;
          4)
            echo "âŒ Configuration error - CI blocked"
            exit 1  # é˜»æ–­CI
            ;;
          *)
            echo "âŒ Unknown error - CI blocked"
            exit 1  # é˜»æ–­CI
            ;;
        esac

  python-sdk-test:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
    
    - name: Test Python SDK import
      run: |
        python -c "
        from leakage_buster.api import audit, plan_fixes, apply_fixes, quick_fix
        print('âœ… Python SDK imports successful')
        "
    
    - name: Test Python SDK functionality
      run: |
        python -c "
        import pandas as pd
        import numpy as np
        from leakage_buster.api import audit, plan_fixes, apply_fixes, quick_fix
        
        # åˆ›å»ºæµ‹è¯•æ•°æ®
        df = pd.DataFrame({
            'date': pd.date_range('2023-01-01', periods=50, freq='D'),
            'amount': np.random.normal(100, 20, 50),
            'y': np.random.binomial(1, 0.3, 50)
        })
        
        # æµ‹è¯•å®¡è®¡
        result = audit(df, 'y', 'date')
        print(f'âœ… Audit completed: {len(result.risks)} risks found')
        
        # æµ‹è¯•ä¿®å¤è®¡åˆ’
        plan = plan_fixes(result)
        print(f'âœ… Fix plan created: {len(plan.actions)} actions')
        
        # æµ‹è¯•å¿«é€Ÿä¿®å¤
        df_fixed, audit_result = quick_fix(df, 'y', 'date')
        print(f'âœ… Quick fix completed: {df_fixed.shape[1]} columns remaining')
        
        print('âœ… All Python SDK tests passed')
        "

  documentation:
    runs-on: ubuntu-latest
    needs: test
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: 3.11
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -e .
        pip install sphinx sphinx-rtd-theme
    
    - name: Generate documentation
      run: |
        # è¿™é‡Œå¯ä»¥æ·»åŠ æ–‡æ¡£ç”Ÿæˆé€»è¾‘
        echo "Documentation generation placeholder"
    
    - name: Check README
      run: |
        if [ -f "README.md" ]; then
          echo "âœ… README.md exists"
          wc -l README.md
        else
          echo "âŒ README.md missing"
          exit 1
        fi

